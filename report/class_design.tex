\section{Thiáº¿t káº¿ lá»›p}

\subsection{Thiáº¿t káº¿ chi tiáº¿t cÃ¡c lá»›p chá»§ Ä‘áº¡o}

Pháº§n nÃ y trÃ¬nh bÃ y thiáº¿t káº¿ chi tiáº¿t cÃ¡c thuá»™c tÃ­nh vÃ  phÆ°Æ¡ng thá»©c cho 4 lá»›p chá»§ Ä‘áº¡o quan trá»ng nháº¥t cá»§a há»‡ thá»‘ng máº¡ng xÃ£ há»™i Ã¢m nháº¡c.

\subsubsection{Lá»›p User (NgÆ°á»i dÃ¹ng)}

Lá»›p User lÃ  lá»›p trung tÃ¢m cá»§a há»‡ thá»‘ng, quáº£n lÃ½ thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ  cÃ¡c má»‘i quan há»‡ xÃ£ há»™i.

\textbf{Thuá»™c tÃ­nh:}
\begin{itemize}
    \item \texttt{id: Long} - KhÃ³a chÃ­nh, tá»± Ä‘á»™ng tÄƒng
    \item \texttt{username: String} - TÃªn Ä‘Äƒng nháº­p, duy nháº¥t, khÃ´ng null
    \item \texttt{email: String} - Äá»‹a chá»‰ email, duy nháº¥t, khÃ´ng null
    \item \texttt{password: String} - Máº­t kháº©u Ä‘Ã£ mÃ£ hÃ³a, khÃ´ng null
    \item \texttt{fullName: String} - Há» tÃªn Ä‘áº§y Ä‘á»§
    \item \texttt{bio: String} - Tiá»ƒu sá»­ ngÆ°á»i dÃ¹ng
    \item \texttt{profileImageUrl: String} - URL áº£nh Ä‘áº¡i diá»‡n
    \item \texttt{role: String} - Vai trÃ² (USER/ADMIN), máº·c Ä‘á»‹nh "USER"
    \item \texttt{banReason: String} - LÃ½ do bá»‹ cáº¥m (náº¿u cÃ³)
    \item \texttt{bannedAt: LocalDateTime} - Thá»i gian bá»‹ cáº¥m
    \item \texttt{bannedBy: String} - NgÆ°á»i thá»±c hiá»‡n cáº¥m
    \item \texttt{lastLoginAt: LocalDateTime} - Láº§n Ä‘Äƒng nháº­p cuá»‘i
    \item \texttt{following: Set<User>} - Danh sÃ¡ch ngÆ°á»i Ä‘ang theo dÃµi
    \item \texttt{followers: Set<User>} - Danh sÃ¡ch ngÆ°á»i theo dÃµi
    \item \texttt{tracks: Set<Track>} - Danh sÃ¡ch bÃ i hÃ¡t Ä‘Ã£ táº£i lÃªn
    \item \texttt{likedTracks: Set<Track>} - Danh sÃ¡ch bÃ i hÃ¡t yÃªu thÃ­ch
    \item \texttt{playlists: Set<Playlist>} - Danh sÃ¡ch playlist sá»Ÿ há»¯u
    \item \texttt{likedPlaylists: Set<Playlist>} - Danh sÃ¡ch playlist yÃªu thÃ­ch
    \item \texttt{listeningHistory: Set<ListeningHistory>} - Lá»‹ch sá»­ nghe nháº¡c
    \item \texttt{preferences: UserPreference} - Sá»Ÿ thÃ­ch cÃ¡ nhÃ¢n
    \item \texttt{createdAt: LocalDateTime} - Thá»i gian táº¡o tÃ i khoáº£n
    \item \texttt{updatedAt: LocalDateTime} - Thá»i gian cáº­p nháº­t cuá»‘i
\end{itemize}

\textbf{PhÆ°Æ¡ng thá»©c chÃ­nh:}
\begin{itemize}
    \item \texttt{onCreate(): void} - Lifecycle method, thiáº¿t láº­p thá»i gian táº¡o
    \item \texttt{onUpdate(): void} - Lifecycle method, cáº­p nháº­t thá»i gian sá»­a Ä‘á»•i
    \item \texttt{equals(Object o): boolean} - So sÃ¡nh Ä‘á»‘i tÆ°á»£ng dá»±a trÃªn id
    \item \texttt{hashCode(): int} - TÃ­nh hash code dá»±a trÃªn id
    \item \texttt{toString(): String} - Chuyá»ƒn Ä‘á»•i sang chuá»—i hiá»ƒn thá»‹
\end{itemize}

\subsubsection{Lá»›p Track (BÃ i hÃ¡t)}

Lá»›p Track Ä‘áº¡i diá»‡n cho má»™t bÃ i hÃ¡t trong há»‡ thá»‘ng vá»›i Ä‘áº§y Ä‘á»§ metadata vÃ  thÃ´ng tin thá»‘ng kÃª.

\textbf{Thuá»™c tÃ­nh:}
\begin{itemize}
    \item \texttt{id: Long} - KhÃ³a chÃ­nh, tá»± Ä‘á»™ng tÄƒng
    \item \texttt{title: String} - TÃªn bÃ i hÃ¡t, khÃ´ng null
    \item \texttt{artist: String} - TÃªn nghá»‡ sÄ©, khÃ´ng null
    \item \texttt{album: String} - TÃªn album
    \item \texttt{genre: String} - Thá»ƒ loáº¡i nháº¡c
    \item \texttt{coverImageUrl: String} - URL áº£nh bÃ¬a
    \item \texttt{audioUrl: String} - URL file Ã¢m thanh
    \item \texttt{duration: Integer} - Thá»i lÆ°á»£ng bÃ i hÃ¡t (giÃ¢y)
    \item \texttt{jamendoId: String} - ID tá»« Jamendo API (náº¿u cÃ³)
    \item \texttt{user: User} - NgÆ°á»i dÃ¹ng táº£i lÃªn (many-to-one)
    \item \texttt{playlists: Set<Playlist>} - Danh sÃ¡ch playlist chá»©a bÃ i hÃ¡t
    \item \texttt{likedBy: Set<User>} - Danh sÃ¡ch ngÆ°á»i dÃ¹ng yÃªu thÃ­ch
    \item \texttt{playCount: Integer} - Sá»‘ láº§n phÃ¡t, máº·c Ä‘á»‹nh 0
    \item \texttt{rating: Double} - Äiá»ƒm Ä‘Ã¡nh giÃ¡ trung bÃ¬nh, máº·c Ä‘á»‹nh 0.0
    \item \texttt{ratingCount: Integer} - Sá»‘ lÆ°á»£t Ä‘Ã¡nh giÃ¡, máº·c Ä‘á»‹nh 0
    \item \texttt{createdAt: LocalDateTime} - Thá»i gian táº¡o
    \item \texttt{updatedAt: LocalDateTime} - Thá»i gian cáº­p nháº­t
\end{itemize}

\textbf{PhÆ°Æ¡ng thá»©c chÃ­nh:}
\begin{itemize}
    \item \texttt{onCreate(): void} - Thiáº¿t láº­p thá»i gian táº¡o vÃ  cáº­p nháº­t
    \item \texttt{onUpdate(): void} - Cáº­p nháº­t thá»i gian sá»­a Ä‘á»•i
    \item \texttt{getAverageRating(): Double} - Tráº£ vá» Ä‘iá»ƒm Ä‘Ã¡nh giÃ¡ trung bÃ¬nh
    \item \texttt{setAverageRating(Double): void} - Thiáº¿t láº­p Ä‘iá»ƒm Ä‘Ã¡nh giÃ¡
    \item \texttt{incrementPlayCount(): void} - TÄƒng sá»‘ láº§n phÃ¡t
    \item \texttt{equals(Object o): boolean} - So sÃ¡nh dá»±a trÃªn id, title, artist
    \item \texttt{hashCode(): int} - TÃ­nh hash code dá»±a trÃªn id, title, artist
\end{itemize}

\subsubsection{Lá»›p RecommendationServiceImpl (Dá»‹ch vá»¥ gá»£i Ã½)}

Lá»›p nÃ y triá»ƒn khai logic nghiá»‡p vá»¥ phá»©c táº¡p cho há»‡ thá»‘ng gá»£i Ã½ nháº¡c thÃ´ng minh.

\textbf{Thuá»™c tÃ­nh dependency:}
\begin{itemize}
    \item \texttt{listeningHistoryRepository: ListeningHistoryRepository} - Repository lá»‹ch sá»­ nghe
    \item \texttt{trackRepository: TrackRepository} - Repository bÃ i hÃ¡t
    \item \texttt{trackMapper: TrackMapper} - Mapper chuyá»ƒn Ä‘á»•i Track-DTO
    \item \texttt{userPreferenceRepository: UserPreferenceRepository} - Repository sá»Ÿ thÃ­ch
    \item \texttt{userPreferenceService: UserPreferenceService} - Service sá»Ÿ thÃ­ch ngÆ°á»i dÃ¹ng
    \item \texttt{trackService: TrackService} - Service bÃ i hÃ¡t
    \item \texttt{MIN\_LISTENING\_DURATION: int = 30} - Thá»i gian nghe tá»‘i thiá»ƒu (giÃ¢y)
\end{itemize}

\textbf{PhÆ°Æ¡ng thá»©c chÃ­nh:}
\begin{itemize}
    \item \texttt{getRecommendationsForUser(Long userId, Pageable): Page<TrackDTO>} - Láº¥y gá»£i Ã½ tá»•ng há»£p cho ngÆ°á»i dÃ¹ng
    \item \texttt{getRecommendationsByArtist(Long userId, int limit): List<TrackDTO>} - Gá»£i Ã½ dá»±a trÃªn nghá»‡ sÄ© yÃªu thÃ­ch
    \item \texttt{getRecommendationsByGenre(Long userId, int limit): List<TrackDTO>} - Gá»£i Ã½ dá»±a trÃªn thá»ƒ loáº¡i yÃªu thÃ­ch
    \item \texttt{getSimilarArtistTracks(Long userId, int limit): List<TrackDTO>} - TÃ¬m bÃ i hÃ¡t cá»§a nghá»‡ sÄ© tÆ°Æ¡ng tá»±
    \item \texttt{getSimilarGenreTracks(Long userId, int limit): List<TrackDTO>} - TÃ¬m bÃ i hÃ¡t thá»ƒ loáº¡i tÆ°Æ¡ng tá»±
    \item \texttt{getFollowingLikedTracks(Long userId, int limit): List<TrackDTO>} - Láº¥y bÃ i hÃ¡t Ä‘Æ°á»£c ngÆ°á»i theo dÃµi yÃªu thÃ­ch
    \item \texttt{getFallbackRecommendations(Long userId, Pageable): Page<TrackDTO>} - Gá»£i Ã½ dá»± phÃ²ng khi khÃ´ng cÃ³ dá»¯ liá»‡u
\end{itemize}

\subsubsection{Lá»›p Playlist (Danh sÃ¡ch phÃ¡t)}

Lá»›p Playlist quáº£n lÃ½ collection cÃ¡c bÃ i hÃ¡t Ä‘Æ°á»£c tá»• chá»©c theo chá»§ Ä‘á» hoáº·c sá»Ÿ thÃ­ch.

\textbf{Thuá»™c tÃ­nh:}
\begin{itemize}
    \item \texttt{id: Long} - KhÃ³a chÃ­nh, tá»± Ä‘á»™ng tÄƒng
    \item \texttt{name: String} - TÃªn playlist, khÃ´ng null
    \item \texttt{description: String} - MÃ´ táº£ playlist
    \item \texttt{coverImageUrl: String} - URL áº£nh bÃ¬a playlist
    \item \texttt{isPublic: Boolean} - Tráº¡ng thÃ¡i cÃ´ng khai
    \item \texttt{user: User} - NgÆ°á»i táº¡o playlist (many-to-one)
    \item \texttt{tracks: Set<Track>} - Danh sÃ¡ch bÃ i hÃ¡t trong playlist
    \item \texttt{likedBy: Set<User>} - Danh sÃ¡ch ngÆ°á»i dÃ¹ng yÃªu thÃ­ch playlist
    \item \texttt{playCount: Integer} - Sá»‘ láº§n phÃ¡t playlist, máº·c Ä‘á»‹nh 0
    \item \texttt{createdAt: LocalDateTime} - Thá»i gian táº¡o
    \item \texttt{updatedAt: LocalDateTime} - Thá»i gian cáº­p nháº­t
\end{itemize}

\textbf{PhÆ°Æ¡ng thá»©c chÃ­nh:}
\begin{itemize}
    \item \texttt{onCreate(): void} - Thiáº¿t láº­p thá»i gian táº¡o vÃ  playCount
    \item \texttt{onUpdate(): void} - Cáº­p nháº­t thá»i gian sá»­a Ä‘á»•i
    \item \texttt{addTrack(Track track): void} - ThÃªm bÃ i hÃ¡t vÃ o playlist
    \item \texttt{removeTrack(Track track): void} - XÃ³a bÃ i hÃ¡t khá»i playlist
    \item \texttt{getTotalDuration(): Integer} - TÃ­nh tá»•ng thá»i lÆ°á»£ng playlist
    \item \texttt{getTrackCount(): Integer} - Äáº¿m sá»‘ bÃ i hÃ¡t trong playlist
    \item \texttt{incrementPlayCount(): void} - TÄƒng sá»‘ láº§n phÃ¡t
\end{itemize}

\subsection{Biá»ƒu Ä‘á»“ trÃ¬nh tá»± cho cÃ¡c use case quan trá»ng}

\subsubsection{Use Case 1: NgÆ°á»i dÃ¹ng phÃ¡t má»™t bÃ i hÃ¡t}

\begin{verbatim}
sequenceDiagram
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸ–¥ï¸ Frontend
    participant TrackController as ğŸ›ï¸ TrackController
    participant TrackService as ğŸ”§ TrackService
    participant ListeningHistoryService as ğŸ“Š ListeningHistoryService
    participant TrackRepository as ğŸ—„ï¸ TrackRepository
    participant ListeningHistoryRepository as ğŸ“‹ ListeningHistoryRepository
    participant UserPreferenceService as âš™ï¸ UserPreferenceService

    User->>Frontend: Click play button on track
    Frontend->>TrackController: POST /api/tracks/{trackId}/play
    TrackController->>TrackService: playTrack(trackId, userId)
    
    TrackService->>TrackRepository: findById(trackId)
    TrackRepository-->>TrackService: Track entity
    
    TrackService->>TrackService: incrementPlayCount()
    TrackService->>TrackRepository: save(track)
    
    TrackService->>ListeningHistoryService: recordListeningHistory(userId, trackId)
    ListeningHistoryService->>ListeningHistoryRepository: save(listeningHistory)
    
    TrackService->>UserPreferenceService: updateFromListeningActivity(userId, track)
    UserPreferenceService->>UserPreferenceService: analyzeAndUpdatePreferences()
    
    TrackService-->>TrackController: TrackDTO
    TrackController-->>Frontend: HTTP 200 + TrackDTO
    Frontend-->>User: Start playing audio + UI update
\end{verbatim}

\subsubsection{Use Case 2: Há»‡ thá»‘ng táº¡o gá»£i Ã½ nháº¡c cÃ¡ nhÃ¢n hÃ³a}

\begin{verbatim}
sequenceDiagram
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸ–¥ï¸ Frontend
    participant RecommendationController as ğŸ¯ RecommendationController
    participant RecommendationService as ğŸ¤– RecommendationService
    participant UserPreferenceService as âš™ï¸ UserPreferenceService
    participant TrackRepository as ğŸ—„ï¸ TrackRepository
    participant UserPreferenceRepository as ğŸ‘¥ UserPreferenceRepository
    participant ListeningHistoryRepository as ğŸ“‹ ListeningHistoryRepository

    User->>Frontend: Navigate to Home/Recommendations
    Frontend->>RecommendationController: GET /api/recommendations/user/{userId}
    RecommendationController->>RecommendationService: getRecommendationsForUser(userId, pageable)
    
    RecommendationService->>UserPreferenceService: hasValidListeningHistory(userId)
    UserPreferenceService->>ListeningHistoryRepository: countByUserId(userId)
    ListeningHistoryRepository-->>UserPreferenceService: count
    UserPreferenceService-->>RecommendationService: boolean
    
    alt Has valid listening history
        RecommendationService->>UserPreferenceService: updatePreferencesFromListeningHistory(userId)
        UserPreferenceService->>ListeningHistoryRepository: findByUserIdWithMinDuration(userId)
        ListeningHistoryRepository-->>UserPreferenceService: List<ListeningHistory>
        UserPreferenceService->>UserPreferenceService: analyzePreferences()
        UserPreferenceService->>UserPreferenceRepository: save(userPreference)
    end
    
    RecommendationService->>RecommendationService: getRecommendationsByArtist(userId, 10)
    RecommendationService->>UserPreferenceRepository: findByUserId(userId)
    UserPreferenceRepository-->>RecommendationService: UserPreference
    RecommendationService->>TrackRepository: findByArtistIgnoreCaseAndIdNotIn(artists, excludedIds)
    TrackRepository-->>RecommendationService: List<Track>
    
    RecommendationService->>RecommendationService: getRecommendationsByGenre(userId, 10)
    RecommendationService->>TrackRepository: findByGenreIgnoreCaseAndIdNotIn(genres, excludedIds)
    TrackRepository-->>RecommendationService: List<Track>
    
    RecommendationService->>RecommendationService: combineAndDeduplicateRecommendations()
    RecommendationService->>RecommendationService: shuffleAndPaginate()
    
    RecommendationService-->>RecommendationController: Page<TrackDTO>
    RecommendationController-->>Frontend: HTTP 200 + RecommendationResponse
    Frontend-->>User: Display personalized recommendations
\end{verbatim}

\subsubsection{Use Case 3: NgÆ°á»i dÃ¹ng táº¡o vÃ  chia sáº» playlist cÃ´ng khai}

\begin{verbatim}
sequenceDiagram
    participant User as ğŸ‘¤ User
    participant Frontend as ğŸ–¥ï¸ Frontend
    participant PlaylistController as ğŸ“ PlaylistController
    participant PlaylistService as ğŸµ PlaylistService
    participant NotificationService as ğŸ”” NotificationService
    participant PlaylistRepository as ğŸ—‚ï¸ PlaylistRepository
    participant UserRepository as ğŸ‘¥ UserRepository
    participant NotificationRepository as ğŸ“¢ NotificationRepository

    User->>Frontend: Create new playlist form
    Frontend->>PlaylistController: POST /api/playlists
    PlaylistController->>PlaylistService: createPlaylist(createPlaylistDTO, userId)
    
    PlaylistService->>UserRepository: findById(userId)
    UserRepository-->>PlaylistService: User entity
    
    PlaylistService->>PlaylistService: validatePlaylistData()
    PlaylistService->>PlaylistRepository: save(playlist)
    PlaylistRepository-->>PlaylistService: Saved Playlist
    
    alt Playlist is public
        PlaylistService->>UserRepository: findFollowersByUserId(userId)
        UserRepository-->>PlaylistService: List<User> followers
        
        loop For each follower
            PlaylistService->>NotificationService: createPlaylistShareNotification(userId, followerId, playlistId)
            NotificationService->>NotificationRepository: save(notification)
        end
    end
    
    PlaylistService-->>PlaylistController: PlaylistDTO
    PlaylistController-->>Frontend: HTTP 201 + PlaylistDTO
    Frontend-->>User: Success message + redirect to playlist

    Note over NotificationService: Async notification sending
    NotificationService->>NotificationService: sendRealTimeNotifications()
    NotificationService-->>Frontend: WebSocket notifications to followers
\end{verbatim}

CÃ¡c biá»ƒu Ä‘á»“ trÃ¬nh tá»± nÃ y minh há»a luá»“ng tÆ°Æ¡ng tÃ¡c giá»¯a cÃ¡c Ä‘á»‘i tÆ°á»£ng trong ba use case quan trá»ng nháº¥t cá»§a há»‡ thá»‘ng: phÃ¡t nháº¡c vá»›i tracking, táº¡o gá»£i Ã½ thÃ´ng minh, vÃ  chia sáº» playlist xÃ£ há»™i. Má»—i biá»ƒu Ä‘á»“ thá»ƒ hiá»‡n rÃµ rÃ ng trÃ¡ch nhiá»‡m cá»§a tá»«ng lá»›p vÃ  cÃ¡ch chÃºng phá»‘i há»£p Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng nghiá»‡p vá»¥. 